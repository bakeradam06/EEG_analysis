
```{r}
# EEG analysis

################################################################################
####### CMC analysis, potenitally for dissertation, conference abstract ########
################################################################################

## load libraries
library(readr) # for reading csv files
library(dplyr) # for data manipulation
library(ggplot2) # for visualization
library(tidyr) # for data tidying
library(Hmisc)
library(lme4)
library(car)
library(performance)
# import CSV file with subject IDs and analyze CMC over time, as well as beta vs gamma, muscle, brain region, etc
# set working directory to folder with all step9 excel files
allData.df <- read_csv("/Users/DOB223/Library/CloudStorage/OneDrive-MedicalUniversityofSouthCarolina/Documents/lab/studies/1eeg/TNTanalysis/allDataForAnalyzeTNT.txt")

# add new variable ("connection") by pairing together the BrainRegion and Muscle
allData.df <- allData.df %>%
  mutate(connection = factor(paste0(BrainRegion, '-', Muscle)))
# make subject and session factors
allData.df$Subject <- factor(allData.df$Subject)
allData.df$session <- factor(allData.df$session)
# basic descriptives of allData.df
summary(allData.df)
describe(allData.df)
# check for missing values
missing_values <- sapply(allData.df, function(x) sum(is.na(x)))
print(missing_values)
# some missing data known just because CMC data not in these data for specific subjects yet,
# but we have WMFT. Let's get rid of those.
allData.df <- allData.df%>%
  filter(!is.na(pinchIncludeTrial)) # filter out the na rows
# check
x = is.na(allData.df)
sum(is.na(x)) # should return 0

```

```{r}
# first, check how many rows there are per subject
summary_by_subject <- allData.df %>%
    group_by(Subject) %>%
    dplyr::summarise(n_rows = n()) %>%
    arrange(n_rows)
# bar graph of it
ggplot(summary_by_subject, aes(x = Subject, y = n_rows)) +
    geom_bar(stat = "identity", fill = "steelblue") +
    theme_minimal() +
    labs(
        title = "Rows per Subject",
        x = "Subject",
        y = "Number of Rows"
    )

rm(summary_by_subject)
```

```{r - calculating change scores}

########################
# change scores - BNOT WORKING NEED TO KEEEP WORKINGG ON IT
dWMFTpreFU <- allData.df %>%
  filter(session %in% c(`Baseline`, `FU 1`), !is.na(WFMTavgTime)) %>%
  group_by(Subject) %>%
  filter(n_distinct(session) == 2) %>%
  pivot_wider(names_from = session, values_from = WFMTavgTime) %>%
  mutate(dWFMTpreFU = `FU 1` - `Baseline`)

varsToKeep1 <- c(
  "Subject",
  "session",
  "ARATscore",
  "WFMTavgTime",
  "WMFTavgHand",
  "BBTaffected",
  "NHPTafffected"
)


cohVarsToKeep <- c(
  'Subject',
  'session',
  'Coh',
  'connection',
  'BrainRegion',
  'Muscle'
  )
# remove the undesired vars
cohDataTemp.df <- allData.df%>% select(all_of(cohVarsToKeep))
cohDataTemp.df <- pivot_wider(cohDataTemp.df, 
                              names_from = c('Subject','session','connection'), 
                              values_from = 'Coh')


clinicalDataTemp.df <- allData.df %>% select(all_of(varsToKeep))
clinicalDataTemp.df <- pivot_wider(clinicalDataTemp.df, 
                                   names_from = c('Subject', 'session','connection'), 
                                   values_from = c('ARATscore',
                                                   'WFMTavgTime',
                                                   'WMFTavgHand',
                                                   'Coh','BBTaffected',
                                                   'NHPTafffected'))


allData2.df <- pivot_wider(allData.df, names_from = c('Subject','session'), values_from = )
allData2.df$dWFMTpreFU <- allData.df$WFMTavgTime["FU"] - allData.df$WFMTavgTime["Pre"] 


# examine normality
hist(unique(allData_baseline.df$WFMTavgTime),breaks=25) 
qqnorm(unique(allData_baseline.df$WFMTavgTime)) # WMFT abnormally distriubuted
hist(unique(allData_baseline.df$ARATscore)) 
qqnorm(unique(allData_baseline.df$ARATscore)) # ARAT seems normal


hist(unique(log(test2.df$ARATscore)),breaks=10)
hist(unique(test2.df$ARATscore),breaks=10)
##################
```


```{r - "How does CMC of PML-APB associate with baseline ARAT score during prep of grip?"}
# needs: 
  # baseline ARAT, CMC scores of prep phase, no execution phase here
  # keep beta, gamma, NoVib. Don't include Vib in this. Baseline only.

test1.df <- allData.df %>%
  filter(connection == "PML-APB", Band == "Beta", Phase == "Exe", Cond == "NoVib") %>%
  group_by(Subject, connection) %>%
  summarise(meanCoh = mean(Coh), 
            meanWMFT = mean(WFMTavgTime),
            age = first(age), # chatGPT showed me the first() command
            sex = first(sex),
            race = first(race),
            typeStroke = first(typeStroke),
            timeSinceStrokeMonth = first(timeSinceStrokeMonth),
            group = first(group),
            ARATscore = first(ARATscore),
            .groups = "drop"
            )

model1 <- glm(ARATscore ~ 
                meanCoh + 
                timeSinceStrokeMonth,
                data = test1.df)

Anova(model1, type = 'III')
model_parameters(model1)
check_model(model1)


```
 Does PML-APB CMC in gamma at baseline during grip associate with baseline ARAT score? I hypothesize it will.
```{r}

test2.df <- allData.df %>%
  group_by(Subject) %>%
  filter(Band == "Gamma", 
         Phase == "Exe", 
         connection == "PML-APB", 
         session == "Baseline", 
         Condition == "NoVib") %>%
  summarise(meanCoh = mean(Coh),
            ARATscore = first(ARATscore),
            WFMTscore = first(WFMTavgTime),
            timeSinceStrokeMonth = first(timeSinceStrokeMonth),
            age = first(age),
            typeStroke = first(typeStroke)) # get avg coh data for data specified above, 
                                  # as well as pre ARAT & WMFT, TSS (no averaging for those).

# basic plotting before model
test2.df %>%
  ggplot(aes(x=meanCoh, y=ARATscore)) +
  geom_point2() +
  geom

model2 <- glm(ARATscore ~
          meanCoh + typeStroke,
          data = test2.df
          )
# model residuals don't look as good with log(ARATscore) as raw ARAT.

Anova(model2, type = 'III')
check_model(model2)
r2(model2)
model_parameters(model2)
check_heteroscedasticity(model2)
check_residuals(model2)
vif(model2)
plot_model(model2)

# r2 = 0.128. 
# model residuals look pretty good. Check_residuals(model2) returns p=0.929, indicating normality in residuals
# overall, not a very good model, but a starting point. Hypothesis not supported.
```
```{r}
test3.df <- allData.df %>%
  group_by(Subject) %>%
  filter(Phase == "Exe", 
         Band == "Gamma", 
         BrainRegion == "M1L", 
         Condition == "NoVib",
         session == "Baseline") %>%
  summarise(meanCoh = mean(Coh),
            ARATscore = first(ARATscore),
            WFMTscore = first(WFMTavgTime),
            timeSinceStrokeMonth = first(timeSinceStrokeMonth),
            age = first(age),
            typeStroke = first(typeStroke))
  
model3 <- lm(ARATscore ~ 
              meanCoh +
              typeStroke,
              data = test3.df
              )

Anova(model3, type = 'III')

model_parameters(model3)
check_residuals(model3)
check_model(model3)

plot_model(model3)
```

```{r - second model. looking at PML-APB connection for explaining motor recovery}
# question: does connection PML connectivity during grip preparation (-2 to 0s before grip) significantly explain baseline motor fx? 
# filter everything away that's not PML.. specify to gamma

test4.df <- allData.df %>%
  group_by(Subject, connection) %>%
  filter(Phase == "Prep", 
         Band == "Gamma", 
         BrainRegion == "PML", 
         Condition == "NoVib",
         session == "Baseline") %>%
  summarise(meanCoh = mean(Coh),
            ARATscore = first(ARATscore),
            WFMTscore = first(WFMTavgTime),
            timeSinceStrokeMonth = first(timeSinceStrokeMonth),
            age = first(age),
            typeStroke = first(typeStroke))
  
model4 <- lm(ARATscore ~ 
              meanCoh*connection +
              typeStroke,
              data = test4.df
              )

Anova(model4, type = 'III')

model_parameters(model4)
check_residuals(model4)
check_model(model4)

plot_model(model4)

```
Does PML-APB change in prep during gamma associate with motor recovery from rehab?

```{r}
# prepare dataset
filtDataGamExe.df <- allData.df %>%
  group_by(Subject,session,connection) %>%
  filter(Band == "Gamma",
         Phase == "Exe") %>%
  summarise(meanCoh = mean(Coh), # average trials by subject x session x connection together
  .groups = "drop"
  )

demogData.df <- allData.df %>% 
  distinct(Subject, session, age, NHPTafffected, ARATscore, WFMTavgTime, BBTaffected)
filtDataGamExe.df <- left_join(filtDataGamExe.df, 
                               demogData.df, 
                               by=c("Subject","session"))

# output: avg coh data across trials x session and connection with age, NHPT, WMFT, ARAT.. Coh data 
# within gamma band, execution phase

# filter down what i just created
tempPMLM1Ldata.df <- filtDataGamExe.df %>%
  #filter(connection %in% c("PML-FDI","PML-EDC","M1L-FDI","M1L-EDC"),
  filter(connection %in% c("PML-EDC"),
         session %in% c("Baseline"))
# model
modGamExeNHPT <-  glm(NHPTafffected ~ 
                      meanCoh,
                      data = tempPMLM1Ldata.df
                      )
Anova(modGamExeNHPT, type = 'III')
model_parameters(modGamExeNHPT)

################################################
# 9HPT and meanCoh have significant relationship (t(149) = -2.27, p=0.023). 
# session more significant when NHPT predicting meanCoh (p=0.149) than vice-versa (p=0.783)
# becomes not significant when session or one of "PML-EDC", "M1L-EDC" is removed. 
################################################


########################
###### plotting ########
########################
filtDataGamExe2.df <- filtDataGamExe.df %>%
  filter(connection %in% c("PML-FDI","PML-EDC",
                           "M1L-FDI","M1L-EDC"))
filtDataGamExe2.df %>%
  filter(session == 'Baseline') %>%
  ggplot(aes(x=NHPTafffected, y=meanCoh)) +
    geom_point() +
    geom_smooth(method = "lm", se = TRUE) +
    facet_wrap(~connection,ncol=4,nrow=4)
filtDataGamExe2.df %>%
  filter(connection == 'PML-EDC',
         session == 'Baseline') %>%
  ggplot(aes(x=meanCoh, y=ARATscore)) +
    geom_point() +
    geom_smooth(method = "lm", se = TRUE)
```


```{r - second bit of modeling. same research question.}
# essentially the same analysis above, just in beta band and not gamma

filtData2.df <- allData.df %>%
  group_by(Subject,session,connection) %>%
  filter(Condition == "NoVib",
         Band == "Beta",
         Phase == "Exe",
         connection %in% c("PML-FDI","PML-EDC","M1L-FDI","M1L-EDC"))
filtData2.df <- filtData2.df %>%
  group_by(Subject, session, connection) %>%
  summarise(meanCoh = mean(Coh), # average trials by subject x session x connection together
            .groups = 'drop')
filtData2.df <- left_join(filtData2.df, 
                           demogData.df, by=c("Subject","session")) # join demog data

# filter down what i just created
temp_filtData2.df <- filtData2.df %>%
  #filter(connection %in% c("PML-FDI","PML-EDC","M1L-FDI","M1L-EDC"),
  filter(connection %in% c("M1L-EDC"), # For ASNR 2026 abstract poster, change between "M1L-EDC" and "PML-EDC", then run two models below.
         session %in% c("Baseline"))
# model - NHPT 
modGamExeNHPTa <-  lm(NHPTafffected ~ 
                       meanCoh, 
                       data = temp_filtData2.df
                       )
Anova(modGamExeNHPTa, type = 'III')
model_parameters(modGamExeNHPTa) # "PML-EDC": p<0.001; "PML-FDI": p=0.653, "M1L-FDI": p=0.799; M1L-EDC: p=0.002
# model - BBT
modGamExeBBTa <-  lm(BBTaffected ~ 
                       meanCoh,
                       data = temp_filtData2.df
                       )
Anova(modGamExeBBTa, type = 'III')
model_parameters(modGamExeBBTa) # "PML-EDC": p=0.004; "PML-FDI": p=0.169, "M1L-FDI": p=0.190; M1L-EDC: p=0.235
cor(temp_filtData2.df$meanCoh,temp_filtData2.df$NHPTafffected)
cor(temp_filtData2.df$meanCoh,temp_filtData2.df$BBTaffected)

###### plotting ########
temp_filtData2.df %>%
  filter(session == 'Baseline') %>%
  ggplot(aes(x=NHPTafffected, y=meanCoh)) +
    geom_point() +
    geom_smooth(method = "lm", se = TRUE)# +
    #facet_wrap(~connection,ncol=4,nrow=4)
temp_filtData2.df %>%
  filter(#connection == 'PML-EDC',
         session == 'Baseline') %>%
  ggplot(aes(x=meanCoh, y=ARATscore)) +
    geom_point() +
    geom_smooth(method = "lm", se = TRUE)


```
take 3 modeling - see below for notes. same research question, just comparing between bands/phases
```{r - same modeling, but beta prep}

filtData3.df <- allData.df %>%
  group_by(Subject,session,connection) %>%
  filter(Condition == "NoVib",
         Band == "Beta",
         Phase == "Prep",
         connection %in% c("PML-FDI","PML-EDC","M1L-FDI","M1L-EDC"))
filtData3.df <- filtData3.df %>%
  group_by(Subject, session, connection) %>%
  summarise(meanCoh = mean(Coh), # average trials by subject x session x connection together
            .groups = 'drop')
filtData3.df <- left_join(filtData3.df, 
                           demogData.df, by=c("Subject","session")) # join demog data

# filter down what i just created
temp_filtData3.df <- filtData3.df %>%
  filter(connection %in% c("PML-FDI"),
  #filter(connection %in% c("PML-FDI"),
         session %in% c("Baseline"))
# model - NHPT
modGamExeNHPTb <-  glm(BBTaffected ~ 
                       meanCoh,
                       data = temp_filtData3.df
                       )
Anova(modGamExeNHPTb, type = 'III')
model_parameters(modGamExeNHPTb)
cor(temp_filtData3.df$meanCoh,temp_filtData3.df$BBTaffected)
# model - BBT
modGamExeBBTb <-  glm(ARATscore ~ 
                       meanCoh,
                       data = temp_filtData3.df
                       )
Anova(modGamExeBBTb, type = 'III')
model_parameters(modGamExeBBTb)
cor(temp_filtData3.df$meanCoh,temp_filtData3.df$ARATscore)


###### plotting ########
temp_filtData3.df %>%
  filter(session == 'Baseline') %>%
  ggplot(aes(x=meanCoh, y=BBTaffected)) +
    geom_point() +
    geom_smooth(method = "lm", se = TRUE) +
    facet_wrap(~connection,ncol=4,nrow=4)
temp_filtData3.df %>%
  filter(connection == 'PML-FDI',
         session == 'Baseline') %>%
  ggplot(aes(x=meanCoh, y=ARATscore)) +
    geom_point() +
    geom_smooth(method = "lm", se = TRUE)

# nothing significant here at time of writing - 12/2/2025.
```

```{r - same as above}
filtData4.df <- allData.df %>%
  group_by(Subject,session,connection) %>%
  filter(Condition == "NoVib",
         Band == "Gamma",
         Phase == "Prep",
         connection %in% c("PML-FDI","PML-EDC","M1L-FDI","M1L-EDC"))
filtData4.df <- filtData4.df %>%
  group_by(Subject, session, connection) %>%
  summarise(meanCoh = mean(Coh), # average trials by subject x session x connection together
            .groups = 'drop')
filtData4.df <- left_join(filtData4.df, 
                           demogData.df, by=c("Subject","session")) # join demog data

# filter down what i just created
temp_filtData4.df <- filtData4.df %>%
  filter(connection %in% c("PML-FDI"),
  #filter(connection %in% c("PML-FDI"),
         session %in% c("Baseline"))
# model - NHPT
modGamExeNHPTc <-  glm(BBTaffected ~ 
                       meanCoh,
                       data = temp_filtData4.df
                       )
Anova(modGamExeNHPTc, type = 'III')
model_parameters(modGamExeNHPTc)
cor(temp_filtData4.df$meanCoh,temp_filtData4.df$BBTaffected)
# model - BBT
modGamExeBBTc <-  glm(ARATscore ~ 
                       meanCoh,
                       data = temp_filtData4.df
                       )
Anova(modGamExeBBTc, type = 'III')
model_parameters(modGamExeBBTc)
cor(temp_filtData4.df$meanCoh,temp_filtData4.df$ARATscore)

###### plotting ########
temp_filtData4.df %>%
  filter(session == 'Baseline') %>%
  ggplot(aes(x=meanCoh, y=BBTaffected)) +
    geom_point() +
    geom_smooth(method = "lm", se = TRUE) +
    facet_wrap(~connection,ncol=2,nrow=2)
temp_filtData4.df %>%
  filter(session == 'Baseline') %>%
  ggplot(aes(x=meanCoh, y=ARATscore)) +
    geom_point() +
    geom_smooth(method = "lm", se = TRUE)
    facet_wrap(~connection,ncol=2,nrow=2)

    
# nothing significant here at time of writing - 12/2/2025.
```






Now moving onto assessing effects of time. All previous modeling was at baseline.
```{r - Investigate time with PML-EDC connection in beta during exe}

filtData21a.df <- allData.df %>%
  group_by(Subject,session,connection) %>%
  filter(Condition == "NoVib",
         Band == "Beta",
         Phase == "Exe",
         connection %in% c("PML-FDI","PML-EDC","M1L-FDI","M1L-EDC"))
filtData21a.df <- filtData21a.df %>%
  group_by(Subject, session, connection) %>%
  summarise(meanCoh = mean(Coh), # average trials by subject x session x connection together
            .groups = 'drop')
filtData211.df <- filtData21a.df %>%
  pivot_wider(
    names_from = connection, 
    values_from = meanCoh) # pivot to wide take 1 for calculating change scores

filtData211.df <- filtData211.df %>%
  pivot_wider(
    names_from = session, 
    values_from = c(`M1L-EDC`, `M1L-FDI`, `PML-EDC`, `PML-FDI`)) # pivot to wide take 1 for calculating change scores
    
filtData211.df <- left_join(filtData21a.df, 
                           demogData.df, by=c("Subject","session")) # join demog data
# compute change scores
# post-pre
filtData211.df <- filtData211.df %>%
  mutate(across(
    ends_with("Post 1"),
    ~ . - get(sub("Post 1$", "Baseline", cur_column())),
    .names = "{sub('Post 1$', 'change_PrePost', .col)}"
  ))
# fu-pre
filtData211.df <- filtData211.df %>%
  mutate(across(
    ends_with("FU 1"),
    ~ . - get(sub("FU 1$", "Baseline", cur_column())),
    .names = "{sub('FU 1$', 'change_PreFU', .col)}"
  ))


# filter down what i just created
temp_filtData211.df <- filtData211.df %>%
  #filter(connection %in% c("PML-FDI","PML-EDC","M1L-FDI","M1L-EDC"),
  filter(connection %in% c("PML-EDC"),
         session %in% c("Baseline", "Post 1"))
# model - NHPT
modGamExeNHPTa1 <-  glm(NHPTafffected ~ 
                       meanCoh +
                       session,
                       data = temp_filtData21.df
                       )
Anova(modGamExeNHPTa1, type = 'III')
model_parameters(modGamExeNHPTa1)
# model - BBT
modGamExeBBTa1 <-  glm(BBTaffected ~ 
                       meanCoh + 
                       session,
                       data = temp_filtData21.df
                       )
Anova(modGamExeBBTa1, type = 'III')
model_parameters(modGamExeBBTa1)

###### plotting ########
temp_filtData2.df %>%
#  filter(session == 'Baseline') %>%
  ggplot(aes(x=NHPTafffected, y=meanCoh)) +
    geom_point() +
    geom_smooth(method = "lm", se = TRUE)
cor(temp_filtData21.df$meanCoh,temp_filtData21.df$NHPTafffected)

temp_filtData2.df %>%
  #filter(#connection == 'PML-EDC',
   #      session == 'Baseline') %>%
  ggplot(aes(x=meanCoh, y=ARATscore)) +
    geom_point() +
    geom_smooth(method = "lm", se = TRUE)
cor(temp_filtData21.df$meanCoh,temp_filtData21.df$ARATscore)

```


```{r}
```








