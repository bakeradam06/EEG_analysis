
```{r}
# EEG analysis

################################################################################
####### CMC analysis, potenitally for dissertation, conference abstract ########
################################################################################

## load libraries
library(readr) # for reading csv files
library(dplyr) # for data manipulation
library(ggplot2) # for visualization
library(tidyr) # for data tidying
library(Hmisc)
# import CSV file with subject IDs and analyze CMC over time, as well as beta vs gamma, muscle, brain region, etc
# set working directory to folder with all step9 excel files
allData.df <- read_csv("/Users/DOB223/Library/CloudStorage/OneDrive-MedicalUniversityofSouthCarolina/Documents/lab/studies/1eeg/TNTanalysis/allDataForAnalyzeTNT.txt")

# add new variable ("connection") by pairing together the BrainRegion and Muscle
allData.df <- allData.df %>%
  mutate(connection = factor(paste0(BrainRegion, '-', Muscle)))
# make subject and session factors
allData.df$Subject <- factor(allData.df$Subject)
allData.df$session <- factor(allData.df$session)
# basic descriptives of allData.df
summary(allData.df)
describe(allData.df)
# check for missing values
missing_values <- sapply(allData.df, function(x) sum(is.na(x)))
print(missing_values)
# some missing data known just because CMC data not in these data for specific subjects yet,
# but we have WMFT. Let's get rid of those.
allData.df <- allData.df%>%
  filter(!is.na(pinchIncludeTrial)) # filter out the na rows
# check
x = is.na(allData.df)
sum(is.na(x)) # should return 0

```

```{r}
# first, check how many rows there are per subject
summary_by_subject <- allData.df %>%
    group_by(Subject) %>%
    dplyr::summarise(n_rows = n()) %>%
    arrange(n_rows)
# bar graph of it
ggplot(summary_by_subject, aes(x = Subject, y = n_rows)) +
    geom_bar(stat = "identity", fill = "steelblue") +
    theme_minimal() +
    labs(
        title = "Rows per Subject",
        x = "Subject",
        y = "Number of Rows"
    )

rm(summary_by_subject)
```

```{r - calculating change scores}

########################
# change scores - BNOT WORKING NEED TO KEEEP WORKINGG
dWMFTpreFU <- allData.df %>%
  filter(session %in% c(`Baseline`, `FU 1`), !is.na(WFMTavgTime)) %>%
  group_by(Subject) %>%
  filter(n_distinct(session) == 2) %>%
  pivot_wider(names_from = session, values_from = WFMTavgTime) %>%
  mutate(dWFMTpreFU = `FU 1` - `Baseline`)

varsToKeep <- c(
  "Subject",
  "session",
  "ARATscore",
  "WFMTavgTime",
  "WMFTavgHand",
  "connection",
  "Coh",
  "BBTaffected",
  "NHPTafffected"
)
# remove the undesired vars
clinicalDataTemp.df <- allData.df %>% select(all_of(varsToKeep))
  
  
  
  
  
  
smallDataTemp <- allData.df %>%
  filter()

allData2.df <- pivot_wider(allData.df, names_from = c('Subject','session'), values_from = )
allData2.df$dWFMTpreFU <- allData.df$WFMTavgTime["FU"] - allData.df$WFMTavgTime["Pre"] 




##################
```


```{r - "How does CMC of PML-APB associate with baseline WMFT score during prep of grip?"}
# needs: 
  # baseline WMFT, CMC scores of prep phase, no execution phase here
  # keep beta, gamma, novib. Don't include Vib in this. Baseline only.

# exclude data i don't want (see above)
analysis1.df <- allData.df %>%
  filter(session == "Baseline", 
         Phase == "Prep", 
         Condition == "NoVib",
         BrainRegion == "PML",
         Band == "Beta",
         )

test1.df <- analysis1.df %>%
  filter(connection %in% c("PML-APB", "PML-EDC", "PML-FDS", "PML-FDI")) %>%
  group_by(Subject, connection) %>%
  summarise(meanCoh = mean(Coh), 
            meanWMFT = mean(WFMTavgTime),
            age = first(age), # chatGPT showed me the first() command
            sex = first(sex),
            race = first(race),
            typeStroke = first(typeStroke),
            timeSinceStrokeMonth = first(timeSinceStrokeMonth),
            group = first(group),
            ARATscore = first(ARATscore),
            .groups = "drop"
            )

model1 <- glm(log(meanWMFT) ~ meanCoh*connection + timeSinceStrokeMonth + age + sex + typeStroke,
      data = test1.df)
Anova(model1, type = 'III')
model_parameters(model1)

```
 How does PML-APB CMC change over time in gamma during grip change predict?
```{r}

test2.df <- allData.df %>%
  filter(Band == "Gamma", Phase == "Exe", BrainRegion == "PML")

model2 <- lmer(log(WFMTavgTime) ~ 
          # fixed effects
          Coh*connection*session + 
          timeSinceStrokeMonth + 
          group + 
          age + 
          typeStroke +
          # random effects
          (session | Subject),
          data = test2.df
          )


test3.df <- allData.df %>%
  filter(Phase == "Exe", Band == "Gamma", BrainRegion == "M1L")

model3_M1L <- lmer(log(WFMTavgTime) ~
                     # fixed effects
                     Coh + 
                     session +
                     group + 
                     timeSinceStrokeMonth + 
                     typeStroke + 
                     age +
                     # random effects
                     (session | Subject),
                     data = test3.df
                     )
Anova(model3_M1L, type = 'III')

model_parameters(model3_M1L)
```

```{r - second model. looking at PML-APB connection for explaining motor recovery}
# question: does connection PML connectivity during grip preparation (-2 to 0s before grip) significantly help explain motor recovery? 




```



