
```{r}
# EEG analysis

################################################################################
####### CMC analysis, potenitally for dissertation, conference abstract ########
################################################################################

## load libraries
library(readr) # for reading csv files
library(dplyr) # for data manipulation
library(ggplot2) # for visualization
library(tidyr) # for data tidying
library(Hmisc)
library(lme4)
# import CSV file with subject IDs and analyze CMC over time, as well as beta vs gamma, muscle, brain region, etc
# set working directory to folder with all step9 excel files
allData.df <- read_csv("/Users/DOB223/Library/CloudStorage/OneDrive-MedicalUniversityofSouthCarolina/Documents/lab/studies/1eeg/TNTanalysis/allDataForAnalyzeTNT.txt")

# add new variable ("connection") by pairing together the BrainRegion and Muscle
allData.df <- allData.df %>%
  mutate(connection = factor(paste0(BrainRegion, '-', Muscle)))
# make subject and session factors
allData.df$Subject <- factor(allData.df$Subject)
allData.df$session <- factor(allData.df$session)
# basic descriptives of allData.df
summary(allData.df)
describe(allData.df)
# check for missing values
missing_values <- sapply(allData.df, function(x) sum(is.na(x)))
print(missing_values)
# some missing data known just because CMC data not in these data for specific subjects yet,
# but we have WMFT. Let's get rid of those.
allData.df <- allData.df%>%
  filter(!is.na(pinchIncludeTrial)) # filter out the na rows
# check
x = is.na(allData.df)
sum(is.na(x)) # should return 0

```

```{r}
# first, check how many rows there are per subject
summary_by_subject <- allData.df %>%
    group_by(Subject) %>%
    dplyr::summarise(n_rows = n()) %>%
    arrange(n_rows)
# bar graph of it
ggplot(summary_by_subject, aes(x = Subject, y = n_rows)) +
    geom_bar(stat = "identity", fill = "steelblue") +
    theme_minimal() +
    labs(
        title = "Rows per Subject",
        x = "Subject",
        y = "Number of Rows"
    )

rm(summary_by_subject)
```

```{r - calculating change scores}

########################
# change scores - BNOT WORKING NEED TO KEEEP WORKINGG ON IT
dWMFTpreFU <- allData.df %>%
  filter(session %in% c(`Baseline`, `FU 1`), !is.na(WFMTavgTime)) %>%
  group_by(Subject) %>%
  filter(n_distinct(session) == 2) %>%
  pivot_wider(names_from = session, values_from = WFMTavgTime) %>%
  mutate(dWFMTpreFU = `FU 1` - `Baseline`)

varsToKeep1 <- c(
  "Subject",
  "session",
  "ARATscore",
  "WFMTavgTime",
  "WMFTavgHand",
  "BBTaffected",
  "NHPTafffected"
)


cohVarsToKeep <- c(
  'Subject',
  'session',
  'Coh',
  'connection',
  'BrainRegion',
  'Muscle'
  )
# remove the undesired vars
cohDataTemp.df <- allData.df%>% select(all_of(cohVarsToKeep))
cohDataTemp.df <- pivot_wider(cohDataTemp.df, 
                              names_from = c('Subject','session','connection'), 
                              values_from = 'Coh')


clinicalDataTemp.df <- allData.df %>% select(all_of(varsToKeep))
clinicalDataTemp.df <- pivot_wider(clinicalDataTemp.df, 
                                   names_from = c('Subject', 'session','connection'), 
                                   values_from = c('ARATscore',
                                                   'WFMTavgTime',
                                                   'WMFTavgHand',
                                                   'Coh','BBTaffected',
                                                   'NHPTafffected'))


allData2.df <- pivot_wider(allData.df, names_from = c('Subject','session'), values_from = )
allData2.df$dWFMTpreFU <- allData.df$WFMTavgTime["FU"] - allData.df$WFMTavgTime["Pre"] 


# examine normality
hist(unique(allData_baseline.df$WFMTavgTime),breaks=25) 
qqnorm(unique(allData_baseline.df$WFMTavgTime)) # WMFT abnormally distriubuted
hist(unique(allData_baseline.df$ARATscore)) 
qqnorm(unique(allData_baseline.df$ARATscore)) # ARAT seems normal


hist(unique(log(test2.df$ARATscore)),breaks=10)
hist(unique(test2.df$ARATscore),breaks=10)
##################
```


```{r - "How does CMC of PML-APB associate with baseline ARAT score during prep of grip?"}
# needs: 
  # baseline ARAT, CMC scores of prep phase, no execution phase here
  # keep beta, gamma, NoVib. Don't include Vib in this. Baseline only.

test1.df <- allData.df %>%
  filter(connection == "PML-APB", Band == "Beta", Phase == "Exe", Cond == "NoVib") %>%
  group_by(Subject, connection) %>%
  summarise(meanCoh = mean(Coh), 
            meanWMFT = mean(WFMTavgTime),
            age = first(age), # chatGPT showed me the first() command
            sex = first(sex),
            race = first(race),
            typeStroke = first(typeStroke),
            timeSinceStrokeMonth = first(timeSinceStrokeMonth),
            group = first(group),
            ARATscore = first(ARATscore),
            .groups = "drop"
            )

model1 <- glm(ARATscore ~ 
                meanCoh + 
                timeSinceStrokeMonth,
                data = test1.df)

Anova(model1, type = 'III')
model_parameters(model1)
check_model(model1)


```
 Does PML-APB CMC in gamma at baseline during grip associate with baseline ARAT score? I hypothesize it will.
```{r}

test2.df <- allData.df %>%
  group_by(Subject) %>%
  filter(Band == "Gamma", 
         Phase == "Exe", 
         connection == "PML-APB", 
         session == "Baseline", 
         Condition == "NoVib") %>%
  summarise(meanCoh = mean(Coh),
            ARATscore = first(ARATscore),
            WFMTscore = first(WFMTavgTime),
            timeSinceStrokeMonth = first(timeSinceStrokeMonth),
            age = first(age),
            typeStroke = first(typeStroke)) # get avg coh data for data specified above, 
                                  # as well as pre ARAT & WMFT, TSS (no averaging for those).

# basic plotting before model
test2.df %>%
  ggplot(aes(x=meanCoh, y=ARATscore)) +
  geom_point2() +
  geom

model2 <- glm(ARATscore ~
          meanCoh + typeStroke,
          data = test2.df
          )
# model residuals don't look as good with log(ARATscore) as raw ARAT.

Anova(model2, type = 'III')
check_model(model2)
r2(model2)
model_parameters(model2)
check_heteroscedasticity(model2)
check_residuals(model2)
vif(model2)
plot_model(model2)

# r2 = 0.128. 
# model residuals look pretty good. Check_residuals(model2) returns p=0.929, indicating normality in residuals
# overall, not a very good model, but a starting point. Hypothesis not supported.
```
```{r}
test3.df <- allData.df %>%
  group_by(Subject) %>%
  filter(Phase == "Exe", 
         Band == "Gamma", 
         BrainRegion == "M1L", 
         Condition == "NoVib",
         session == "Baseline") %>%
  summarise(meanCoh = mean(Coh),
            ARATscore = first(ARATscore),
            WFMTscore = first(WFMTavgTime),
            timeSinceStrokeMonth = first(timeSinceStrokeMonth),
            age = first(age),
            typeStroke = first(typeStroke))
  
model3 <- lm(ARATscore ~ 
              meanCoh +
              typeStroke,
              data = test3.df
              )

Anova(model3, type = 'III')

model_parameters(model3)
check_residuals(model3)
check_model(model3)

plot_model(model3)
```

```{r - second model. looking at PML-APB connection for explaining motor recovery}
# question: does connection PML connectivity during grip preparation (-2 to 0s before grip) significantly explain baseline motor fx? 
# filter everything away that's not PML.. specify to gamma

test4.df <- allData.df %>%
  group_by(Subject, connection) %>%
  filter(Phase == "Prep", 
         Band == "Gamma", 
         BrainRegion == "PML", 
         Condition == "NoVib",
         session == "Baseline") %>%
  summarise(meanCoh = mean(Coh),
            ARATscore = first(ARATscore),
            WFMTscore = first(WFMTavgTime),
            timeSinceStrokeMonth = first(timeSinceStrokeMonth),
            age = first(age),
            typeStroke = first(typeStroke))
  
model4 <- lm(ARATscore ~ 
              meanCoh*connection +
              typeStroke,
              data = test4.df
              )

Anova(model4, type = 'III')

model_parameters(model4)
check_residuals(model4)
check_model(model4)

plot_model(model4)

```
Does PML-APB change in prep during gamma associate with motor recovery from rehab?
```{r}
# use lmer

filt_pmlApbARAT.df <- allData.df %>%
  filter(Band == "Gamma", 
         Condition == "NoVib",
         Phase == "Exe")

pmlApbRec1<- lmer(Coh ~
                  # fixed effects
                  NHPTafffected + 
                  Muscle + BrainRegion +
                  (1 | Subject),
                  data = filt_pmlApbARAT.df
                  )
Anova(pmlApbRec1,type = 'III')
model_parameters((pmlApbRec1))
# check_model(pmlApbRec)
check_heteroscedasticity(pmlApbRec1)
check_collinearity(pmlApbRec1)
r2(pmlApbRec1)

#############
pmlApbRec12 <- lmer(Coh ~
                  # fixed effects
                  NHPTafffected +
                  BBTaffected + 
                  ARATscore +
                  Muscle + BrainRegion +
                  (1 | Subject),
                  data = filt_pmlApbARAT.df
                  )
Anova(pmlApbRec12,type = 'III')
model_parameters((pmlApbRec12))
# check_model(pmlApbRec)
check_heteroscedasticity(pmlApbRec12)
check_collinearity(pmlApbRec12)
r2(pmlApbRec12)
report(pmlApbRec12)






pmlApbRec2 <- lmer(Coh ~
                  # fixed effects
                  ARATscore + 
                  connection +
                  (1 | Subject),
                  data = filt_pmlApbARAT.df
                  )
Anova(pmlApbRec,type = 'III')
model_parameters((pmlApbRec))
check_heteroscedasticity(pmlApbRec)
check_collinearity(pmlApbRec)
r2(pmlApbRec)

```
Second set of models. PML and motor recovery. same reserach question as above
```{r}
pmlApbRec12 <- lmer(Coh ~
                  # fixed effects
                  NHPTafffected +
                  BBTaffected + 
                  ARATscore +
                  Muscle + BrainRegion +
                  (1 | Subject),
                  data = filt_pmlApbARAT.df
                  )
Anova(pmlApbRec12,type = 'III')
model_parameters((pmlApbRec12))
# check_model(pmlApbRec)
check_heteroscedasticity(pmlApbRec12)
check_collinearity(pmlApbRec12)
r2(pmlApbRec12)
report(pmlApbRec12)


```










Second model, post-hoc: does M1L-APB in gamma during grip associate with motor reocvery?
```{r}

filt_m1lApbARAT.df <- allData.df %>%
  filter(connection == "M1L-EDC", 
         Band == "Beta", 
         Condition == "NoVib",
         Phase == "Exe")

m1lApbRec <- lmer(ARATscore ~
                  # fixed effects
                  Coh*session +
                  (1 | Subject),
                  data = filt_m1lApbARAT.df
                  )
Anova(m1lApbRec,type = 'III')
model_parameters((m1lApbRec))
check_model(m1lApbRec)
check_heteroscedasticity(m1lApbRec)
check_collinearity(m1lApbRec)

```
aggregate data, model according to subject-level CMC data instead of trial-level
```{r}

# create subject level cmc data
groupDataLong.df <- allData.df %>%
  group_by(Subject, session, connection, Band, Phase, Condition) %>%
  summarise(
    meanCoh = mean(Coh),
    ARATscore = first(ARATscore),
    typeStroke = first(typeStroke),
    timeSinceStrokeMonth = first(timeSinceStrokeMonth),
    age = first(age),
    group = first(group), 
    baseARAT = ARATscore["Baseline"],
    .groups = "drop"
  )
# create baseline ARAT score var, then add new new df above
baseARAT <- allData.df %>%
  group_by(Subject) %>%
  filter(session == "Baseline") %>%
  summarise(baseARATscore = first(ARATscore),
            .groups = "drop")
groupDataLong.df <- right_join(groupDataLong.df, baseARAT, by='Subject')
# now have subject level cmc data according to condition and all the other stuff



##### reassess pml-apb association with motor recovery now with group level cmc data..
pmlApbRec2.df <- groupDataLong.df %>%
  filter(Condition == "NoVib", Band == "Gamma", Phase == "Prep", connection == "PML-APB")

pmlApbRec2 <- lmer(ARATscore ~
              # fixed effects
              meanCoh*session + 
              baseARATscore +  
              group +
              # random effects 
              (1 | Subject),
              data = pmlApbRec2.df
              )
Anova(pmlApbRec2, type = 'III')
model_parameters((pmlApbRec2))
check_model(pmlApbRec2)
check_heteroscedasticity(pmlApbRec2)
check_collinearity(pmlApbRec2)
r2(pmlApbRec2)

# nothing significant here. No evidence that PML-APB in gamma during grip prep associates with recovery.

```
Post-hoc - look for associations in M1L-muscle in gamma during exe
```{r}
m1lTest2.df <- groupDataLong.df %>%
  filter(Band == "Gamma", Phase == "Exe", connection == "M1L-EDC")
  
m1lTest2 <- lmer(ARATscore ~
                    # fixed effects
                    meanCoh*session + 
                    # random effects 
                    (1 | Subject),
                    data = m1lTest2.df
                    )
Anova(m1lTest2, type = 'III')
model_parameters((m1lTest2))
check_model(m1lTest2)
check_heteroscedasticity(m1lTest2)
check_collinearity(m1lTest2)
r2(m1lTest2)          

```


```{r}
```


```{r}
```


```{r}
```

 